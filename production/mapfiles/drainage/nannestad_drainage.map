#
# Start of map file
#
MAP
  NAME "Jordplan drainage"
  STATUS ON
  #SIZE 600 600
  EXTENT 3.5 57 32 72
  UNITS DD
  ##SHAPEPATH "data"
  IMAGECOLOR 255 255 255

  IMAGETYPE PNG

  DEBUG 1
  CONFIG "MS_ERRORFILE" "/tmp/drainage_mapserver_error"

  #
  # Start of web interface definition (including WMS enabling metadata)
  #
  WEB
    ##MINSCALE 1000
    ##MAXSCALE 1550000

    # change the next two lines to match your setup
    IMAGEPATH "/var/lib/mapserver/tmp/"
    IMAGEURL "/mapserver/tmp/"

    METADATA
      WMS_TITLE "Drenering - Jordplan"
      WMS_ABSTRACT "Jordplan"
      WMS_ACCESSCONSTRAINTS "Tjenesten skal kun benyttes av de som har faatt eksplisitt tillatelse av Jordplan AS"

      # change this value to match your setup
      WMS_ONLINERESOURCE "https://jordplan.no/wms/nannestad/orkqcr/drainage"
      WMS_SRS "EPSG:4326 EPSG:4258 EPSG:27391 EPSG:27392 EPSG:27393 EPSG:27394 EPSG:27395 EPSG:27396 EPSG:27397 EPSG:27398 EPSG:32631 EPSG:32632 EPSG:32633 EPSG:32634 EPSG:32635 EPSG:32636 EPSG:25831 EPSG:25832 EPSG:25833 EPSG:25834 EPSG:25835 EPSG:25836 EPSG:3785 EPSG:3857"
      WMS_ENABLE_REQUEST "*"   ##necessary
      WMS_FEATURE_INFO_MIME_TYPE "text/html"

      #"wms_feature_info_mime_type" "text/plain"
      #"wms_feature_info_mime_type" "text/html"
    END
  END

  PROJECTION
    "init=epsg:4326"
  END

  #
  # Start of layer definitions
  #
  LAYER
    NAME "drainage_pipe"
    STATUS ON
    CONNECTIONTYPE POSTGIS
    CONNECTION "host=db1 port=5432 dbname=drupal user=mapserver password=AGj3439ZhQXCR"
    DATA "the_geom from (select dp.nid, dp.the_geom, dp.dimension, dp.method, to_char(dp.valid_from,'YYYY-MM-DD') valid_from, dp.material, dp.length
     FROM kommune k
     LEFT JOIN drainage_pipe dp ON ST_Intersects(ST_Transform(k.geom, 4326), dp.the_geom)
     WHERE k.nummer = '3036') as subquery using unique nid using srid=4326"
    TYPE LINE
    #EXTENT 3.5 57 32 72
    EXTENT 10.772026 60.106292 11.129198 60.346692
    CLASS
      STYLE
        COLOR 0 0 255
      END
    END

    HEADER "drainage_pipe_head.html"
    TEMPLATE "drainage_pipe.html"
    FOOTER "drainage_pipe_tail.html"

    METADATA
      WMS_TITLE "Drensledninger - Jordplan"
      WMS_ABSTRACT "Drainage pipes documented in Jordplan"
      wms_include_items "valid_from,dimension,method,material,length"
    END


  END # drainage_pipe

END # Map File
