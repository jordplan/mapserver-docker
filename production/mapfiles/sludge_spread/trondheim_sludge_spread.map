#
# Start of map file
#
MAP
  NAME "Jordplan sludge spread"
  STATUS ON
  #SIZE 600 600
  EXTENT 3.5 57 32 72
  UNITS DD
  ##SHAPEPATH "data"
  IMAGECOLOR 255 255 255

  IMAGETYPE PNG

  DEBUG 1
  CONFIG "MS_ERRORFILE" "/tmp/sludge_spread_mapserver_error"

  #
  # Start of web interface definition (including WMS enabling metadata)
  #
  WEB
    ##MINSCALE 1000
    ##MAXSCALE 1550000

    # change the next two lines to match your setup
    IMAGEPATH "/var/lib/mapserver/tmp/"
    IMAGEURL "/mapserver/tmp/"

    METADATA
      WMS_TITLE "Jordplan Sludge Spread"
      WMS_ABSTRACT "Jordplan"
      WMS_ACCESSCONSTRAINTS "Tjenesten skal kun benyttes av de som har faatt eksplisitt tillatelse av Jordplan AS"

      # change this value to match your setup
      WMS_ONLINERESOURCE "http://jordplan.no/wms/trondheim/n34bMDEsT/sludge_spread"
      WMS_SRS "EPSG:4326 EPSG:4258 EPSG:27391 EPSG:27392 EPSG:27393 EPSG:27394 EPSG:27395 EPSG:27396 EPSG:27397 EPSG:27398 EPSG:32631 EPSG:32632 EPSG:32633 EPSG:32634 EPSG:32635 EPSG:32636 EPSG:25831 EPSG:25832 EPSG:25833 EPSG:25834 EPSG:25835 EPSG:25836 EPSG:3785 EPSG:3857"
      WMS_ENABLE_REQUEST "*"   ##necessary
      WMS_FEATURE_INFO_MIME_TYPE "text/html"

      #"wms_feature_info_mime_type" "text/plain"
      #"wms_feature_info_mime_type" "text/html"
    END
  END

  PROJECTION
    "init=epsg:4326"
  END

  #
  # Start of layer definitions
  #
  LAYER
    NAME "sludge_spread"
    STATUS ON
    CONNECTIONTYPE POSTGIS
    CONNECTION "host=db1 port=5432 dbname=drupal user=mapserver password=AGj3439ZhQXCR"
    DATA "the_geom from (select ss.nid, ss.the_geom, ss.sludge_class, ss.area, to_char(ss.spread_date,'YYYY-MM-DD') spread_date, ss.mass, ss.dry_matter_mass, ss.dry_matter_percentage
      FROM abas_kommune ak
      LEFT JOIN sludge_spread ss ON ST_INTERSECTS(ss.the_geom,ak.the_geom)
      WHERE ak.komm = 1601) as subquery using unique nid using srid=4326"
    CLASSITEM 'sludge_class'
    TYPE POLYGON
    EXTENT 3.5 57 32 72
    CLASS
      EXPRESSION ""
      STYLE
        OPACITY 70
        COLOR 226 76 255
      END
    END
    CLASS
      EXPRESSION "0"
      STYLE
        OPACITY 70
        COLOR 226 76 255
      END
    END
    CLASS
      EXPRESSION "1"
      STYLE
        OPACITY 70
        COLOR 214 0 255
      END
    END
    CLASS
      EXPRESSION "2"
      STYLE
        OPACITY 70
        COLOR 171 0 204
      END
    END
    CLASS
      EXPRESSION "3"
      STYLE
        OPACITY 70
        COLOR 107 0 127
      END
    END

    HEADER "sludge_spread_head.html"
    TEMPLATE "sludge_spread.html"
    FOOTER "sludge_spread_tail.html"

    METADATA
      WMS_TITLE "Jordplan Sludge Spread"
      WMS_ABSTRACT "Sludge documented in Jordplan"
      wms_include_items "spread_date,dry_matter_mass,sludge_class,area"
    END


  END # sludge_spread

END # Map File
